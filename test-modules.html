<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module Loading Test - Tying.ai</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .test-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
        }
        .test-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 10px 10px 0;
            transition: all 0.3s ease;
        }
        .test-button:hover {
            background: #45a049;
            transform: translateY(-2px);
        }
        .status {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 14px;
        }
        .module-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 6px;
            margin: 5px 0;
        }
        .loaded { color: #4CAF50; }
        .pending { color: #FFC107; }
        .error { color: #F44336; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Module Loading Test</h1>
        <p>This page tests the code splitting and lazy loading functionality implemented in Tying.ai</p>

        <div class="test-section">
            <h2>üìä Analytics Module Test</h2>
            <p>Tests loading the analytics module which tracks user interactions and performance metrics.</p>
            <button class="test-button" onclick="loadAnalytics()">Load Analytics Module</button>
            <button class="test-button" onclick="testAnalytics()">Test Analytics Tracking</button>
            <div id="analytics-status" class="status">Status: Not loaded</div>
        </div>

        <div class="test-section">
            <h2>üí¨ Chatbot Module Test</h2>
            <p>Tests loading the AI chatbot module for career guidance and assistance.</p>
            <button class="test-button" onclick="loadChatbot()">Load Chatbot Module</button>
            <button class="test-button" onclick="openChat()">Open Chatbot</button>
            <div id="chatbot-status" class="status">Status: Not loaded</div>
        </div>

        <div class="test-section">
            <h2>üîß Module System Status</h2>
            <button class="test-button" onclick="checkModuleLoader()">Check Module Loader</button>
            <button class="test-button" onclick="showStats()">Show Loading Stats</button>
            <button class="test-button" onclick="clearAll()">Clear All Data</button>
            <div id="system-status" class="status">Click "Check Module Loader" to see system status</div>
        </div>

        <div class="test-section">
            <h2>üìà Performance Test</h2>
            <p>Test performance with multiple module loads and interactions.</p>
            <button class="test-button" onclick="performanceTest()">Run Performance Test</button>
            <button class="test-button" onclick="measureLoadTimes()">Measure Load Times</button>
            <div id="performance-status" class="status">Click to run performance tests</div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/js/module-loader.js"></script>
    <script type="module" src="/js/main.js"></script>

    <script>
        // Global variables for testing
        let loadTimes = {};
        let testResults = {};

        // Test functions
        async function loadAnalytics() {
            const status = document.getElementById('analytics-status');
            status.innerHTML = 'Loading analytics module...';

            const startTime = performance.now();

            try {
                if (window.TyingAI && window.TyingAI.app) {
                    await window.TyingAI.app.loadLazyModule('analytics');
                    loadTimes.analytics = performance.now() - startTime;
                    status.innerHTML = `<span class="loaded">‚úÖ Analytics module loaded (${loadTimes.analytics.toFixed(2)}ms)</span>`;
                    testResults.analytics = true;
                } else {
                    status.innerHTML = '<span class="error">‚ùå Main app not available</span>';
                }
            } catch (error) {
                status.innerHTML = `<span class="error">‚ùå Failed to load: ${error.message}</span>`;
                testResults.analytics = false;
            }
        }

        async function testAnalytics() {
            if (!window.analyticsModule) {
                await loadAnalytics();
            }

            if (window.analyticsModule) {
                try {
                    // Test page tracking
                    window.analyticsModule.trackPageView('/test-page');

                    // Test interaction tracking
                    window.analyticsModule.trackInteraction('click', document.body, { test: true });

                    // Test performance tracking
                    window.analyticsModule.trackPerformance('testMetric', 42);

                    const report = window.analyticsModule.getReport();
                    document.getElementById('analytics-status').innerHTML +=
                        `<br><span class="loaded">‚úÖ Analytics working: ${report.totalEvents} events tracked</span>`;
                } catch (error) {
                    document.getElementById('analytics-status').innerHTML +=
                        `<br><span class="error">‚ùå Analytics test failed: ${error.message}</span>`;
                }
            }
        }

        async function loadChatbot() {
            const status = document.getElementById('chatbot-status');
            status.innerHTML = 'Loading chatbot module...';

            const startTime = performance.now();

            try {
                if (window.TyingAI && window.TyingAI.app) {
                    await window.TyingAI.app.loadLazyModule('chatbot');
                    loadTimes.chatbot = performance.now() - startTime;
                    status.innerHTML = `<span class="loaded">‚úÖ Chatbot module loaded (${loadTimes.chatbot.toFixed(2)}ms)</span>`;
                    testResults.chatbot = true;
                } else {
                    status.innerHTML = '<span class="error">‚ùå Main app not available</span>';
                }
            } catch (error) {
                status.innerHTML = `<span class="error">‚ùå Failed to load: ${error.message}</span>`;
                testResults.chatbot = false;
            }
        }

        async function openChat() {
            if (!window.chatbotModule) {
                await loadChatbot();
            }

            if (window.chatbotModule) {
                try {
                    await window.chatbotModule.initialize();
                    window.chatbotModule.openChat();
                    document.getElementById('chatbot-status').innerHTML +=
                        '<br><span class="loaded">‚úÖ Chatbot opened successfully</span>';
                } catch (error) {
                    document.getElementById('chatbot-status').innerHTML +=
                        `<br><span class="error">‚ùå Failed to open chatbot: ${error.message}</span>`;
                }
            }
        }

        function checkModuleLoader() {
            const status = document.getElementById('system-status');

            if (!window.ModuleLoader) {
                status.innerHTML = '<span class="error">‚ùå Module Loader not available</span>';
                return;
            }

            const stats = window.ModuleLoader.getStats();
            const mainAppStats = window.TyingAI && window.TyingAI.app ?
                window.TyingAI.app.getLoadingStats() : null;

            let html = '<strong>Module Loader Status:</strong><br>';
            html += `Loaded modules: ${stats.totalLoaded}<br>`;
            html += `Cached modules: ${stats.totalCached}<br>`;
            html += `Loading modules: ${stats.totalLoading}<br>`;

            if (stats.loadedModules.length > 0) {
                html += '<br><strong>Loaded modules:</strong><br>';
                stats.loadedModules.forEach(module => {
                    html += `<div class="module-info loaded">‚úÖ ${module}</div>`;
                });
            }

            if (mainAppStats) {
                html += '<br><strong>App Module Status:</strong><br>';
                Object.entries(mainAppStats.lazyModules).forEach(([name, loaded]) => {
                    const statusClass = loaded ? 'loaded' : 'pending';
                    const icon = loaded ? '‚úÖ' : '‚è≥';
                    html += `<div class="module-info ${statusClass}">${icon} ${name}: ${loaded ? 'loaded' : 'pending'}</div>`;
                });
            }

            status.innerHTML = html;
        }

        function showStats() {
            if (!window.TyingAI || !window.TyingAI.app) {
                document.getElementById('system-status').innerHTML =
                    '<span class="error">‚ùå Main app not available</span>';
                return;
            }

            const stats = window.TyingAI.app.getLoadingStats();
            let html = '<strong>Loading Statistics:</strong><br>';
            html += `Total loaded: ${stats.totalLoaded}/${stats.totalAvailable}<br>`;

            if (loadTimes) {
                html += '<br><strong>Load Times:</strong><br>';
                Object.entries(loadTimes).forEach(([module, time]) => {
                    html += `${module}: ${time.toFixed(2)}ms<br>`;
                });
            }

            if (testResults) {
                html += '<br><strong>Test Results:</strong><br>';
                Object.entries(testResults).forEach(([module, success]) => {
                    const statusClass = success ? 'loaded' : 'error';
                    const icon = success ? '‚úÖ' : '‚ùå';
                    html += `<span class="${statusClass}">${icon} ${module}</span><br>`;
                });
            }

            document.getElementById('system-status').innerHTML = html;
        }

        function clearAll() {
            if (window.analyticsModule) {
                window.analyticsModule.clearData();
            }
            if (window.chatbotModule) {
                window.chatbotModule.clearHistory();
            }
            if (window.ModuleLoader) {
                window.ModuleLoader.clearCache();
            }

            loadTimes = {};
            testResults = {};

            document.getElementById('analytics-status').innerHTML = 'Status: Cleared';
            document.getElementById('chatbot-status').innerHTML = 'Status: Cleared';
            document.getElementById('system-status').innerHTML = 'Status: Cleared';
            document.getElementById('performance-status').innerHTML = 'Status: Cleared';
        }

        async function performanceTest() {
            const status = document.getElementById('performance-status');
            status.innerHTML = 'Running performance test...';

            const startTime = performance.now();
            const testPromises = [];

            // Test loading multiple modules in parallel
            testPromises.push(loadAnalytics());
            testPromises.push(loadChatbot());

            try {
                await Promise.all(testPromises);
                const totalTime = performance.now() - startTime;

                status.innerHTML = `<span class="loaded">‚úÖ Performance test completed in ${totalTime.toFixed(2)}ms</span>`;

                // Test individual performance
                if (loadTimes.analytics && loadTimes.chatbot) {
                    const parallelTime = Math.max(loadTimes.analytics, loadTimes.chatbot);
                    const sequentialTime = loadTimes.analytics + loadTimes.chatbot;
                    const savings = sequentialTime - parallelTime;
                    const percentSavings = (savings / sequentialTime * 100).toFixed(1);

                    status.innerHTML += `<br><span class="loaded">üöÄ Parallel loading saved ${savings.toFixed(2)}ms (${percentSavings}%)</span>`;
                }
            } catch (error) {
                status.innerHTML = `<span class="error">‚ùå Performance test failed: ${error.message}</span>`;
            }
        }

        function measureLoadTimes() {
            const status = document.getElementById('performance-status');

            if (Object.keys(loadTimes).length === 0) {
                status.innerHTML = '<span class="pending">‚è≥ Load some modules first to measure times</span>';
                return;
            }

            let html = '<strong>Module Load Times:</strong><br>';
            const total = Object.values(loadTimes).reduce((sum, time) => sum + time, 0);

            Object.entries(loadTimes).forEach(([module, time]) => {
                const percent = ((time / total) * 100).toFixed(1);
                html += `${module}: ${time.toFixed(2)}ms (${percent}%)<br>`;
            });

            html += `<br><strong>Total: ${total.toFixed(2)}ms</strong>`;
            status.innerHTML = html;
        }

        // Listen for module load events
        window.addEventListener('module:loaded', (event) => {
            console.log('‚úÖ Module loaded:', event.detail);
        });

        window.addEventListener('module:error', (event) => {
            console.error('‚ùå Module load failed:', event.detail);
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üß™ Module loading test page ready');
            setTimeout(checkModuleLoader, 1000);
        });
    </script>
</body>
</html>